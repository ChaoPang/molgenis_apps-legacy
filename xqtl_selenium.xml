<?xml version="1.0" encoding="UTF-8"?>
<project name="xqtl_selenium" default="clean_make_test" basedir=".">

	<description>
		
	Run a Selenium web test on a freshly build xQTL workbench.
		
	At the moment there are two issues that require attention:
		
	1 - The test must be started as root (e.g. sudo ant -f...) under Unix,
		or else creation of the file directory in the application will
		likely fail during the test where the database/storage is setup.
		
	2 - The test must be started in the directory of the Ant script.
		(e.g. NOT: sudo ant -f molgenis_apps/xqtl_s...) If you start it
		from another directory, Selenium cannot find the WebContent
		directory (amongst other resources?) and the test fails.
		
	</description>
	
	<!-- Import development script for reuse -->
	<import file="xqtl_dev.xml" />

	<!-- Import TestNG as an Ant task -->
	<taskdef resource="testngtasks" classpath="../molgenis/lib/testng-5.14.10.jar" />

	<!--
	Wrapper: Complete xQTL Selenium web test.
	Clean dirs, make application and run the test.
	-->
	<target name="clean_make_webtest" description="Make app and start the web test">
		<antcall target="clean_make" />
		<antcall target="webtest" />
	</target>
	
	<!--
	Run xQTL selenium test
	-->
	<target name="webtest" description="Start the Selenium test">
		<testng haltOnFailure="true">
			<xmlfileset dir="${app_build_dir}" includes="**/xqtl_test_selenium.xml" />
			<classpath>
				<path refid="molgenis-libs" />
				<path refid="app-libs" />
				<path location="${mol_build_dir}" />
				<path location="${app_build_dir}" />
			</classpath>
		</testng>
	</target>
		
	<!--
	STANDALONE FUNCTION.
	Test the webtest frameworks to see if they run at all.
	Atm in Hudson as 'web_test_frameworks'. Don't touch.
	-->
	<target name="test_webframeworks">
		<mkdir dir="${app_build_dir}"/>
		<javac srcdir="modules/webserver/test/webtestframeworks" includes="*TestWebFrameworkOnly.java" destdir="${app_build_dir}" includeantruntime="false" debug="on">
			<classpath>
				<path refid="app-libs" />
			</classpath>
		</javac>
		<path id="webserver_path">
			<pathelement location="modules/webserver" />
		</path>
		<pathconvert pathsep="/**/*," refid="webserver_path" property="webserver_path_pattern">
			<regexpmapper from=".*/(.*/.*)" to="\1" />
		</pathconvert>
		<fileset dir="." id="webserver_path" includes="${webserver_path_pattern}/**/*">
			<include name="**/testng_test_${framework}_only.xml" />
			<exclude name="**/*.java" />
		</fileset>
		<copy todir="${app_build_dir}" verbose="true">
			<fileset refid="webserver_path" />
			<mapper type="regexp" from="^[-_a-zA-Z0-9]*/[-_a-zA-Z0-9]*/(.*)" to="\1" />
		</copy>
		<testng haltOnFailure="true">
			<xmlfileset dir="${app_build_dir}/test/webtestframeworks" includes="*_testwebframeworkonly.xml" />
			<classpath>
				<path refid="app-libs" />
				<path location="${app_build_dir}" />
			</classpath>
		</testng>
	</target>
	
</project>